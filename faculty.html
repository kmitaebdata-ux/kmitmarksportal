<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KMIT Marks Portal – Faculty Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- SheetJS for XLSX download -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .sticky-header { position: sticky; top: 0; z-index: 10; }
    .scroll-table { max-height: 460px; overflow: auto; }
    th.sticky-col { position: sticky; left: 0; background: #f9fafb; z-index: 5; }

    /* validation + absentees */
    .cell-error {
      background-color: #fee2e2; /* red-100 */
      border-color: #b91c1c !important; /* red-700 */
    }
    .cell-absent {
      background-color: #fef3c7; /* amber-100 */
      color: #b45309; /* amber-700 */
    }
    .row-absent {
      background-color: #fffbeb; /* amber-50 */
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Top bar -->
<header class="w-full bg-slate-900 text-white px-4 py-3 flex items-center justify-between shadow">
  <div class="flex items-center gap-3">
    <span class="font-semibold text-lg">KMIT Marks Portal – Faculty</span>
    <span id="faculty-role-badge" class="text-xs px-2 py-0.5 bg-emerald-600 rounded-full hidden">FACULTY</span>
  </div>
  <div class="flex items-center gap-3 text-xs">
    <div id="faculty-email" class="truncate max-w-[220px] opacity-90">Loading…</div>
    <button id="logout-btn" class="px-3 py-1 rounded bg-red-500 hover:bg-red-600">Sign Out</button>
  </div>
</header>

<!-- Main layout -->
<main class="flex-1 flex flex-col md:flex-row p-4 gap-4">

  <!-- Left: My Assigned Subjects -->
  <aside class="w-full md:w-72 bg-white rounded-xl shadow-md p-4 flex flex-col">
    <h2 class="text-sm font-semibold mb-2">My Assigned Subjects</h2>
    <p class="text-[11px] text-slate-500 mb-3">
      Subjects are assigned by Admin in Faculty Subject Mapping.
      You may teach multiple sections (A/B/C/D).
    </p>

    <div id="subject-list" class="flex-1 overflow-y-auto space-y-2 text-xs">
      <!-- cards injected -->
    </div>
  </aside>

  <!-- Right: Marks Entry Workspace -->
  <section class="flex-1 bg-white rounded-xl shadow-md p-4 flex flex-col">

    <!-- No subject selected message -->
    <div id="no-subject-message" class="flex-1 flex flex-col items-center justify-center text-center text-sm text-slate-500">
      <p class="mb-2 font-medium">Select a subject to begin marks entry.</p>
      <p class="text-xs text-slate-400">
        Choose a card from <span class="font-semibold">“My Assigned Subjects”</span> on the left.
      </p>
    </div>

    <!-- Marks workspace -->
    <div id="marks-workspace" class="hidden h-full flex flex-col gap-3">

      <!-- Selection header (frozen) -->
      <div class="sticky-header bg-white pb-2 border-b border-slate-200">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
          <div>
            <div class="text-xs text-slate-500">Subject</div>
            <div id="ws-subject-title" class="text-sm font-semibold text-slate-800">–</div>
            <span id="ws-locked-badge" class="mt-1 inline-flex items-center text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 hidden">
              Final Submitted (Locked)
            </span>
          </div>
          <div class="flex flex-wrap gap-4 text-[11px] text-slate-600">
            <div><span class="font-semibold">Reg:</span> <span id="ws-reg">–</span></div>
            <div><span class="font-semibold">Branch:</span> <span id="ws-branch">–</span></div>
            <div><span class="font-semibold">Year/Sem:</span> <span id="ws-year-sem">–</span></div>
            <div><span class="font-semibold">Batch:</span> <span id="ws-batch">–</span></div>
            <div><span class="font-semibold">Section:</span> <span id="ws-section">–</span></div>
            <div><span class="font-semibold">Type:</span> <span id="ws-type">–</span></div>
            <div><span class="font-semibold">Exam:</span> <span id="ws-exam">MID/SEM?</span></div>
          </div>
        </div>
        <div class="mt-2 flex flex-wrap items-center justify-between gap-2 text-[11px]">
          <div class="flex items-center gap-2">
            <span class="font-semibold text-slate-600">Last date for marks submission:</span>
            <span id="ws-last-date" class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">
              Not set (Admin can store in faculty_subjects)
            </span>
          </div>
          <div class="text-[10px] text-slate-400">
            Headers stay fixed while scrolling. Please save frequently.
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="mt-2 flex flex-col lg:flex-row gap-3 justify-between items-start">
        <!-- Student CSV load -->
        <div class="text-xs space-y-1">
          <div class="font-semibold text-slate-700">Step 1 – Load Student List (CSV)</div>
          <p class="text-[11px] text-slate-500">
            Expected columns: <code>hallticket,name,section</code> (extra columns are ignored).
          </p>
          <div class="flex flex-wrap items-center gap-2">
            <input type="file" id="student-csv-input" class="text-[11px]" accept=".csv" />
            <button id="load-students-btn" class="px-3 py-1.5 rounded bg-slate-800 text-white text-[11px] hover:bg-slate-900">
              Load Students
            </button>
          </div>
          <div id="student-load-status" class="text-[11px] text-slate-500 mt-1"></div>
        </div>

        <!-- Export / print / save / lock -->
        <div class="flex flex-wrap gap-2 text-xs">
          <button id="download-csv-btn" class="px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50">
            Download CSV
          </button>
          <button id="download-xlsx-btn" class="px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50">
            Download XLSX
          </button>
          <button id="print-btn" class="px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50">
            Print
          </button>
          <button id="save-marks-btn" class="px-4 py-1.5 rounded bg-emerald-600 text-white hover:bg-emerald-700">
            Save Marks to Firestore
          </button>
          <button id="lock-marks-btn" class="px-4 py-1.5 rounded bg-indigo-600 text-white hover:bg-indigo-700">
            Submit Final (Lock)
          </button>
        </div>
      </div>

      <!-- Marks table -->
      <div id="marks-table-wrapper" class="flex-1 mt-2 border border-slate-200 rounded-lg overflow-hidden">
        <div id="no-students" class="h-full flex items-center justify-center text-sm text-slate-500">
          Load a CSV to view students and enter marks.
        </div>
        <div id="marks-table-container" class="hidden scroll-table bg-white">
          <!-- table injected -->
        </div>
      </div>

      <div id="save-status" class="text-[11px] text-slate-600 mt-1"></div>
    </div>

  </section>

</main>

<!-- Error toast -->
<div id="error-toast" class="fixed bottom-4 right-4 max-w-md hidden">
  <div class="bg-red-50 border border-red-200 text-red-700 text-xs px-3 py-2 rounded shadow">
    <div class="font-semibold text-[11px]">Error</div>
    <div id="error-toast-msg" class="mt-1"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    getDocs,
    query,
    where,
    setDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyC1Aa_mnq_0g7ZEuLbYVjN62iCMWemlKUc",
    authDomain: "kmit-marks-portal-9db76.firebaseapp.com",
    projectId: "kmit-marks-portal-9db76",
    storageBucket: "kmit-marks-portal-9db76.appspot.com",
    messagingSenderId: "264909025742",
    appId: "1:264909025742:web:84de5216860219e6bc3b9f"
  };

  const appId = "kmit-marks-portal";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------- DOM refs ----------
  const emailEl = document.getElementById("faculty-email");
  const roleBadge = document.getElementById("faculty-role-badge");
  const logoutBtn = document.getElementById("logout-btn");
  const subjectListEl = document.getElementById("subject-list");

  const noSubjectMessage = document.getElementById("no-subject-message");
  const marksWorkspace = document.getElementById("marks-workspace");

  const wsSubjectTitle = document.getElementById("ws-subject-title");
  const wsReg = document.getElementById("ws-reg");
  const wsBranch = document.getElementById("ws-branch");
  const wsYearSem = document.getElementById("ws-year-sem");
  const wsBatch = document.getElementById("ws-batch");
  const wsSection = document.getElementById("ws-section");
  const wsType = document.getElementById("ws-type");
  const wsExam = document.getElementById("ws-exam");
  const wsLastDate = document.getElementById("ws-last-date");
  const wsLockedBadge = document.getElementById("ws-locked-badge");

  const studentCsvInput = document.getElementById("student-csv-input");
  const loadStudentsBtn = document.getElementById("load-students-btn");
  const studentLoadStatus = document.getElementById("student-load-status");

  const downloadCsvBtn = document.getElementById("download-csv-btn");
  const downloadXlsxBtn = document.getElementById("download-xlsx-btn");
  const printBtn = document.getElementById("print-btn");
  const saveMarksBtn = document.getElementById("save-marks-btn");
  const lockMarksBtn = document.getElementById("lock-marks-btn");

  const marksTableContainer = document.getElementById("marks-table-container");
  const noStudentsDiv = document.getElementById("no-students");
  const saveStatus = document.getElementById("save-status");

  const errorToast = document.getElementById("error-toast");
  const errorToastMsg = document.getElementById("error-toast-msg");

  // ---------- Global state ----------
  let currentUser = null;
  let currentRole = null;
  let assignments = []; // faculty assigned subjects
  let currentAssignment = null;
  let students = []; // loaded from CSV
  let dynamicColumns = []; // mark columns
  let isLocked = false;

  const fixedColumns = ["S.No", "Hall Ticket No", "Name of the Student", "Section"];

  // THEORY template (aligned with your header)
  const theoryDefaultColumns = [
    "1a","1b","2a","2b","3a","3b","4a","4b","5a","5b",
    "Part-C (5 Marks)",
    "Assignment",
    "Part-A Objective (10 Marks)",
    "Descriptive 15 Marks",
    "Total (40)",
    "Remarks (Numeric)",
    "Remarks (In Words)"
  ];

  // LAB template (kept simple)
  const labDefaultColumns = [
    "Experiment No",
    "Observation / Procedure",
    "Record",
    "Viva",
    "Internal (40)",
    "Remarks (Numeric)",
    "Remarks (In Words)"
  ];

  // ---------- Helpers ----------
  function showError(msg) {
    console.error(msg);
    errorToastMsg.textContent = msg;
    errorToast.classList.remove("hidden");
    setTimeout(() => errorToast.classList.add("hidden"), 6000);
  }

  async function handleLogout() {
    try {
      await signOut(auth);
      window.location.href = "index.html";
    } catch (err) {
      showError("Sign-out failed: " + err.message);
    }
  }

  logoutBtn.addEventListener("click", handleLogout);

  function isDeadlinePassed(dateStr) {
    if (!dateStr) return false;
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return false;
    const today = new Date();
    today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);
    return d < today;
  }

  function renderSubjectCards() {
    if (!assignments.length) {
      subjectListEl.innerHTML =
        '<div class="text-[11px] text-slate-500">No subjects assigned yet. Please contact Admin.</div>';
      return;
    }

    subjectListEl.innerHTML = "";
    assignments.forEach((a, idx) => {
      const card = document.createElement("button");
      card.type = "button";
      card.className =
        "w-full text-left border border-slate-200 rounded-lg px-3 py-2 text-xs hover:border-indigo-400 hover:bg-indigo-50 transition flex flex-col gap-1";
      card.dataset.idx = idx;

      const title = document.createElement("div");
      title.className = "font-semibold text-slate-800";
      title.textContent = `${a.subjectName} (${a.subjectCode}) – ${a.type}`;

      const meta = document.createElement("div");
      meta.className = "text-[11px] text-slate-600 space-y-0.5";
      meta.innerHTML = `
        <div>Reg: ${a.reg} | Branch: ${a.branch}</div>
        <div>Year/Sem: ${a.year} / ${a.sem}</div>
        <div>Batch: ${a.batch || "-"} | Section: ${a.section || "ALL"}</div>
        <div>Exam: ${a.exam || "Not set"}</div>
      `;

      card.appendChild(title);
      card.appendChild(meta);

      card.addEventListener("click", () => selectAssignment(idx));
      subjectListEl.appendChild(card);
    });
  }

  // ---------- role & assignments ----------
  async function fetchRole(uid) {
    const roleRef = doc(db, "artifacts", appId, "users", uid, "user_config", "role");
    const snap = await getDoc(roleRef);
    if (!snap.exists()) return null;
    return (snap.data().role || "").toUpperCase();
  }

  async function fetchAssignments(uid) {
    const colRef = collection(db, "faculty_subjects", uid, "assignedSubjects");
    const snap = await getDocs(colRef);
    const list = [];
    snap.forEach((d) => {
      const data = d.data() || {};
      list.push({
        id: d.id,
        reg: data.reg,
        branch: data.branch,
        year: data.year,
        sem: data.sem,
        subjectName: data.subjectName,
        subjectCode: data.subjectCode,
        type: data.type || "THEORY",
        section: data.section || "ALL",
        batch: data.batch || "",
        exam: data.exam || "",
        lastSubmissionDate: data.lastSubmissionDate || ""
      });
    });
    return list;
  }

  function selectAssignment(index) {
    currentAssignment = assignments[index];
    if (!currentAssignment) return;

    noSubjectMessage.classList.add("hidden");
    marksWorkspace.classList.remove("hidden");

    // header
    wsSubjectTitle.textContent = `${currentAssignment.subjectName} (${currentAssignment.subjectCode})`;
    wsReg.textContent = currentAssignment.reg;
    wsBranch.textContent = currentAssignment.branch;
    wsYearSem.textContent = `${currentAssignment.year} / ${currentAssignment.sem}`;
    wsBatch.textContent = currentAssignment.batch || "-";
    wsSection.textContent = currentAssignment.section || "ALL";
    wsType.textContent = currentAssignment.type || "-";
    wsExam.textContent = currentAssignment.exam || "NOT SET";

    wsLastDate.classList.remove(
      "bg-emerald-100","text-emerald-700",
      "bg-amber-100","text-amber-700",
      "bg-red-100","text-red-700"
    );

    if (currentAssignment.lastSubmissionDate) {
      const passed = isDeadlinePassed(currentAssignment.lastSubmissionDate);
      if (passed) {
        wsLastDate.textContent = `${currentAssignment.lastSubmissionDate} (Deadline passed)`;
        wsLastDate.classList.add("bg-red-100","text-red-700");
      } else {
        wsLastDate.textContent = currentAssignment.lastSubmissionDate;
        wsLastDate.classList.add("bg-emerald-100","text-emerald-700");
      }
    } else {
      wsLastDate.textContent = "Not set (Admin can add in faculty_subjects)";
      wsLastDate.classList.add("bg-amber-100","text-amber-700");
    }

    // template
    dynamicColumns =
      (currentAssignment.type || "THEORY") === "LAB"
        ? [...labDefaultColumns]
        : [...theoryDefaultColumns];

    // reset table state
    students = [];
    isLocked = false;
    marksTableContainer.innerHTML = "";
    marksTableContainer.classList.add("hidden");
    noStudentsDiv.classList.remove("hidden");
    studentLoadStatus.textContent =
      "Subject selected. Now load a CSV with students to enter marks.";
    saveStatus.textContent = "";
    wsLockedBadge.classList.add("hidden");
    saveMarksBtn.disabled = false;
    lockMarksBtn.disabled = false;
  }

  // ---------- CSV parsing / loading ----------
  function parseCSV(text) {
    const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
    if (!lines.length) return [];

    const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
    const idx = {
      hallticket: header.indexOf("hallticket"),
      name: header.indexOf("name"),
      section: header.indexOf("section")
    };

    if (idx.hallticket === -1 || idx.name === -1) {
      throw new Error("CSV must contain at least 'hallticket' and 'name' columns.");
    }

    const result = [];
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(",").map((c) => c.trim());
      if (!row.length || !row[0]) continue;
      const obj = {
        hallticket: row[idx.hallticket] || "",
        name: row[idx.name] || "",
        section: idx.section !== -1 ? (row[idx.section] || "") : (currentAssignment?.section || "")
      };
      if (!obj.hallticket || !obj.name) continue;
      result.push(obj);
    }
    return result;
  }

  function buildStudentIdPrefix() {
    const a = currentAssignment;
    const batch = a.batch || "NA";
    return `${batch}_${a.reg}_${a.branch}_${a.year}_${a.sem}_${a.subjectCode}_${a.section || "ALL"}`;
  }

  function buildStudentDocId(hallticket) {
    return buildStudentIdPrefix() + "_" + hallticket;
  }

  async function loadExistingMarksIntoStudents() {
    if (!currentAssignment || !students.length) return;

    const keyPrefix = buildStudentIdPrefix();

    // per-student marks
    const qRef = query(
      collection(db, "marks_student"),
      where("compositeKeyPrefix", "==", keyPrefix)
    );

    const snap = await getDocs(qRef);
    const byHall = {};
    snap.forEach((d) => {
      const data = d.data();
      byHall[data.hallticket] = data;
    });

    students.forEach((stu) => {
      const m = byHall[stu.hallticket];
      if (m && m.marks) {
        stu.marks = m.marks;
      }
    });

    // sheet doc for lock flag
    const sheetSnap = await getDoc(doc(db, "marksheets", keyPrefix));
    if (sheetSnap.exists()) {
      const s = sheetSnap.data();
      isLocked = !!s.locked;
    } else {
      isLocked = false;
    }
  }

  function getMaxFromColumnName(colName) {
    const m = colName.match(/(\d+)\s*Marks?/i);
    if (!m) return null;
    return parseInt(m[1], 10);
  }

  function renderMarksTable() {
    if (!students.length) {
      marksTableContainer.innerHTML = "";
      marksTableContainer.classList.add("hidden");
      noStudentsDiv.classList.remove("hidden");
      return;
    }

    const allColumns = [...fixedColumns, ...dynamicColumns];

    let html = '<table id="marks-table" class="min-w-full text-[11px] border-collapse">';
    html += "<thead><tr>";
    allColumns.forEach((c, i) => {
      const extra = i < 2 ? "sticky-col" : ""; // freeze first 2
      html += `<th class="border border-slate-300 px-2 py-1 bg-slate-100 text-xs font-semibold ${extra}">${c}</th>`;
    });
    html += "</tr></thead><tbody>";

    students.forEach((stu, rowIndex) => {
      html += "<tr>";
      allColumns.forEach((colName, colIndex) => {
        let cellHtml = "";
        if (colName === "S.No") {
          cellHtml = rowIndex + 1;
        } else if (colName === "Hall Ticket No") {
          cellHtml = stu.hallticket;
        } else if (colName === "Name of the Student") {
          cellHtml = stu.name;
        } else if (colName === "Section") {
          cellHtml = stu.section || "";
        } else {
          const key = colName;
          const existing = stu.marks && stu.marks[key] !== undefined ? stu.marks[key] : "";
          const isRemarksNumeric = key === "Remarks (Numeric)";
          const isRemarksWords = key === "Remarks (In Words)";
          const isDescriptive = key === "Descriptive 15 Marks";
          const isTotal = key === "Total (40)";
          const isNumericField = !isRemarksNumeric && !isRemarksWords;

          const typeAttr = isNumericField ? "number" : "text";
          const readOnlyAttr = (isDescriptive || isTotal) ? "readonly" : "";
          const disabledAttr = isLocked ? "disabled" : "";

          cellHtml = `<input type="${typeAttr}" data-row="${rowIndex}" data-col="${encodeURIComponent(
            key
          )}" value="${existing}" ${readOnlyAttr} ${disabledAttr}
            class="w-full border border-slate-200 rounded px-1 py-0.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-400" />`;
        }

        const extraTd = colIndex < 2 ? "sticky-col bg-white" : "";
        html += `<td class="border border-slate-200 px-2 py-1 ${extraTd}">${cellHtml}</td>`;
      });
      html += "</tr>";
    });

    html += "</tbody></table>";
    marksTableContainer.innerHTML = html;
    noStudentsDiv.classList.add("hidden");
    marksTableContainer.classList.remove("hidden");

    applyStylesToAllInputs();
    applyLockState();
  }

  function applyLockState() {
    if (!marksTableContainer) return;
    const inputs = marksTableContainer.querySelectorAll("input[data-row][data-col]");
    inputs.forEach((inp) => {
      if (isLocked) inp.setAttribute("disabled", "disabled");
      else inp.removeAttribute("disabled");
    });
    if (isLocked) {
      wsLockedBadge.classList.remove("hidden");
      saveMarksBtn.disabled = true;
      lockMarksBtn.disabled = true;
      saveStatus.textContent = "Marks are locked as final.";
    } else {
      wsLockedBadge.classList.add("hidden");
      saveMarksBtn.disabled = false;
      lockMarksBtn.disabled = false;
    }
  }

  function recomputeRow(rowIndex) {
    const table = marksTableContainer.querySelector("#marks-table");
    if (!table) return;
    const rows = table.querySelectorAll("tbody tr");
    const row = rows[rowIndex];
    if (!row) return;

    row.classList.remove("row-absent");

    const inputs = row.querySelectorAll('input[data-row][data-col]');
    const colInfo = {};
    let rowAbsent = false;

    inputs.forEach((input) => {
      const colName = decodeURIComponent(input.dataset.col);
      let raw = input.value.trim();
      let num = null;

      // sanitize: allow blank, -1, or number
      if (raw === "") {
        num = null;
      } else if (raw === "-1") {
        num = -1;
        rowAbsent = true;
      } else {
        const n = Number(raw);
        if (Number.isNaN(n) || n < 0) {
          input.value = "";
          raw = "";
          num = null;
        } else {
          num = n;
        }
      }

      const td = input.closest("td");
      if (td) {
        td.classList.remove("cell-error","cell-absent");
      }

      colInfo[colName] = { input, raw, num, td };
    });

    // mark cell-level errors/absentees
    Object.keys(colInfo).forEach((name) => {
      const { num, td } = colInfo[name];
      if (!td) return;
      if (num === -1) {
        td.classList.add("cell-absent");
      } else if (num != null) {
        const max = getMaxFromColumnName(name);
        if (max != null && num > max) {
          td.classList.add("cell-error");
        }
      }
    });

    // compute best-4 descriptive from question pairs
    const qMarks = [];
    for (let q = 1; q <= 6; q++) {
      const aKey = `${q}a`;
      const bKey = `${q}b`;
      const a = colInfo[aKey];
      const b = colInfo[bKey];
      if (!a || !b) continue;

      if (a.num === -1 || b.num === -1) {
        rowAbsent = true;
      }

      const av = (a.num != null && a.num > 0) ? a.num : 0;
      const bv = (b.num != null && b.num > 0) ? b.num : 0;

      if (!rowAbsent) {
        qMarks.push(av + bv);
      }
    }

    const descLabel = "Descriptive 15 Marks";
    const partALabel = "Part-A Objective (10 Marks)";
    const partCLabel = "Part-C (5 Marks)";
    const totalLabel = "Total (40)";

    const descCell = colInfo[descLabel];
    const partACell = colInfo[partALabel];
    const partCCell = colInfo[partCLabel];
    const totalCell = colInfo[totalLabel];

    if (descCell) {
      const { input, td } = descCell;
      td.classList.remove("cell-error","cell-absent");
      if (rowAbsent) {
        input.value = "-1";
        td.classList.add("cell-absent");
      } else {
        let sum = 0;
        if (qMarks.length) {
          const sorted = [...qMarks].sort((a,b)=>b-a);
          const best = sorted.slice(0,4);
          sum = best.reduce((s,v)=>s+v,0);
        }
        if (sum === 0) {
          input.value = "";
        } else {
          const capped = Math.min(sum, 15);
          input.value = String(capped);
        }
      }
      descCell.raw = input.value.trim();
      descCell.num = descCell.raw === "" ? null : (descCell.raw === "-1" ? -1 : Number(descCell.raw));
      if (descCell.num === -1) rowAbsent = true;
    }

    // recompute total
    if (totalCell) {
      const { input, td } = totalCell;
      td.classList.remove("cell-error","cell-absent");

      if (rowAbsent) {
        input.value = "-1";
        td.classList.add("cell-absent");
        row.classList.add("row-absent");
        return;
      }

      const pA = partACell && partACell.num != null && partACell.num > 0 ? partACell.num : 0;
      const pC = partCCell && partCCell.num != null && partCCell.num > 0 ? partCCell.num : 0;
      const dN = descCell && descCell.num != null && descCell.num > 0 ? descCell.num : 0;

      let tot = pA + pC + dN;
      if (tot === 0) {
        input.value = "";
      } else {
        const capped = Math.min(tot, 40);
        input.value = String(capped);
        if (capped > 40) td.classList.add("cell-error");
      }
    }

    if (rowAbsent) {
      row.classList.add("row-absent");
    }
  }

  function applyStylesToAllInputs() {
    const table = marksTableContainer.querySelector("#marks-table");
    if (!table) return;
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach((_, idx) => recomputeRow(idx));
  }

  // live input handler
  marksTableContainer.addEventListener("input", (e) => {
    const input = e.target;
    if (!input.matches('input[data-row][data-col]')) return;
    if (isLocked) return;

    // sanitize just this input
    let raw = input.value.trim();
    if (raw === "") {
      input.value = "";
    } else if (raw === "-1") {
      // ok
    } else {
      const n = Number(raw);
      if (Number.isNaN(n) || n < 0) {
        input.value = "";
      }
    }
    applyStylesToAllInputs();
  });

  // ---------- load students ----------
  loadStudentsBtn.addEventListener("click", async () => {
    if (!currentAssignment) {
      showError("Select a subject first.");
      return;
    }
    const file = studentCsvInput.files[0];
    if (!file) {
      showError("Please choose a CSV file with student list.");
      return;
    }

    try {
      studentLoadStatus.textContent = "Reading CSV…";
      const text = await file.text();
      students = parseCSV(text);
      studentLoadStatus.textContent = `Loaded ${students.length} students. Fetching any saved marks…`;
      await loadExistingMarksIntoStudents();
      renderMarksTable();
      studentLoadStatus.textContent = `Loaded ${students.length} students. Existing marks merged.`;
      saveStatus.textContent = "";
    } catch (err) {
      showError(err.message || String(err));
      studentLoadStatus.textContent = "Failed to load students.";
    }
  });

  // ---------- Export: CSV ----------
  function getRowsForExport() {
    const allCols = [...fixedColumns, ...dynamicColumns];
    const rows = [allCols];

    students.forEach((stu, idx) => {
      const row = [];
      allCols.forEach((colName) => {
        if (colName === "S.No") row.push(String(idx + 1));
        else if (colName === "Hall Ticket No") row.push(stu.hallticket || "");
        else if (colName === "Name of the Student") row.push(stu.name || "");
        else if (colName === "Section") row.push(stu.section || "");
        else {
          const key = colName;
          const val = stu.marks ? stu.marks[key] : "";
          row.push(val === undefined ? "" : String(val));
        }
      });
      rows.push(row);
    });

    return rows;
  }

  downloadCsvBtn.addEventListener("click", () => {
    if (!students.length) {
      showError("No data to download. Load students and enter marks first.");
      return;
    }
    const rows = getRowsForExport();
    const csv = rows.map((r) =>
      r
        .map((cell) =>
          /[\",\n]/.test(cell) ? '"' + cell.replace(/"/g, '""') + '"' : cell
        )
        .join(",")
    ).join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const aMeta = currentAssignment || {};
    a.href = url;
    a.download = `${aMeta.subjectCode || "subject"}_${aMeta.section || "sec"}_marks.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // ---------- Export: XLSX ----------
  downloadXlsxBtn.addEventListener("click", () => {
    if (!students.length) {
      showError("No data to download. Load students and enter marks first.");
      return;
    }

    const rows = getRowsForExport();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Marks");

    const meta = currentAssignment || {};
    const fileName = `${meta.subjectCode || "subject"}_${meta.section || "sec"}_marks.xlsx`;
    XLSX.writeFile(wb, fileName);
  });

  // ---------- Print ----------
  printBtn.addEventListener("click", () => {
    if (!students.length) {
      showError("No data to print.");
      return;
    }
    const printWindow = window.open("", "_blank");
    const tableHtml = marksTableContainer.innerHTML;
    const headerHtml = `
      <h2 style="font-family:Inter,sans-serif;font-size:16px;margin-bottom:4px;">KESHAV MEMORIAL INSTITUTE OF TECHNOLOGY</h2>
      <h3 style="font-family:Inter,sans-serif;font-size:14px;margin-bottom:4px;">Marks Sheet – ${wsSubjectTitle.textContent}</h3>
      <div style="font-size:11px;margin-bottom:8px;">
        Reg: ${wsReg.textContent} | Branch: ${wsBranch.textContent} | Year/Sem: ${wsYearSem.textContent} |
        Batch: ${wsBatch.textContent} | Section: ${wsSection.textContent} | Type: ${wsType.textContent}
      </div>
    `;
    printWindow.document.write(`
      <html><head>
        <title>Marks Sheet</title>
        <style>
          table { border-collapse: collapse; width:100%; font-size:11px; }
          th, td { border: 1px solid #000; padding: 3px 4px; }
          th { background:#e5e7eb; }
          input { border:none; outline:none; }
        </style>
      </head>
      <body>${headerHtml}${tableHtml}</body></html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  });

  // ---------- Save Marks ----------
  function collectMarksFromTable() {
    const inputs = marksTableContainer.querySelectorAll("input[data-row][data-col]");
    students.forEach((s) => (s.marks = {}));

    inputs.forEach((input) => {
      const rowIndex = parseInt(input.dataset.row, 10);
      const key = decodeURIComponent(input.dataset.col);
      const value = input.value;
      if (!students[rowIndex].marks) students[rowIndex].marks = {};
      students[rowIndex].marks[key] = value;
    });
  }

  async function saveMarksCore(silent = false) {
    if (!currentAssignment) {
      showError("Select a subject first.");
      return;
    }
    if (!students.length) {
      showError("No students loaded.");
      return;
    }

    // do not save if any validation errors
    const errorCells = marksTableContainer.querySelectorAll(".cell-error");
    if (errorCells.length > 0) {
      showError("Some marks exceed the maximum allowed (10 / 15 / 40 etc.). Fix red-highlighted cells before saving.");
      saveStatus.textContent = "Fix validation errors before saving.";
      return;
    }

    collectMarksFromTable();

    const prefix = buildStudentIdPrefix();
    const meta = currentAssignment;
    const allCols = [...fixedColumns, ...dynamicColumns];

    const rowsForSheet = students.map((stu, idx) => {
      const row = { sNo: idx + 1, hallticket: stu.hallticket, name: stu.name, section: stu.section };
      dynamicColumns.forEach((c) => {
        const v = stu.marks ? stu.marks[c] : "";
        row[c] = v;
      });
      return row;
    });

    if (!silent) {
      saveStatus.textContent = "Saving marks to Firestore…";
    }

    try {
      const writes = students.map((stu) => {
        const data = {
          compositeKeyPrefix: prefix,
          compositeKey: buildStudentDocId(stu.hallticket),
          hallticket: stu.hallticket,
          name: stu.name,
          section: stu.section,
          batch: meta.batch || "",
          reg: meta.reg,
          branch: meta.branch,
          year: meta.year,
          sem: meta.sem,
          subjectCode: meta.subjectCode,
          subjectName: meta.subjectName,
          type: meta.type,
          exam: meta.exam || "",
          marks: stu.marks || {}
        };
        return setDoc(
          doc(db, "marks_student", data.compositeKey),
          data,
          { merge: true }
        );
      });

      await Promise.all(writes);

      const sheetId = prefix;
      const sheetDoc = {
        compositeKeyPrefix: prefix,
        batch: meta.batch || "",
        reg: meta.reg,
        branch: meta.branch,
        year: meta.year,
        sem: meta.sem,
        subjectCode: meta.subjectCode,
        subjectName: meta.subjectName,
        type: meta.type,
        exam: meta.exam || "",
        section: meta.section || "",
        columns: allCols,
        rows: rowsForSheet
      };
      await setDoc(doc(db, "marksheets", sheetId), sheetDoc, { merge: true });

      if (!silent) {
        saveStatus.textContent = "Marks saved successfully.";
      }
    } catch (err) {
      console.error(err);
      showError("Failed to save marks: " + err.message);
      saveStatus.textContent = "Error saving marks.";
    }
  }

  saveMarksBtn.addEventListener("click", () => {
    if (isLocked) {
      showError("Marks are locked as final. You cannot edit.");
      return;
    }
    saveMarksCore(false);
  });

  lockMarksBtn.addEventListener("click", async () => {
    if (!currentAssignment) {
      showError("Select a subject first.");
      return;
    }
    if (!students.length) {
      showError("No students loaded.");
      return;
    }
    if (!window.confirm("Are you sure you want to submit final marks and lock this sheet? You will not be able to edit after this.")) {
      return;
    }

    await saveMarksCore(false);

    const prefix = buildStudentIdPrefix();
    try {
      await setDoc(
        doc(db, "marksheets", prefix),
        {
          locked: true,
          lockedBy: currentUser ? currentUser.uid : null,
          lockedAt: new Date().toISOString()
        },
        { merge: true }
      );
      isLocked = true;
      applyLockState();
    } catch (err) {
      showError("Failed to lock marks: " + err.message);
    }
  });

  // ---------- Auth + bootstrap ----------
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    currentUser = user;
    emailEl.textContent = user.email || user.uid;

    try {
      const role = await fetchRole(user.uid);
      currentRole = role;
      if (role === "FACULTY") {
        roleBadge.classList.remove("hidden");
      } else if (role === "ADMIN") {
        window.location.href = "admin.html";
        return;
      } else {
        showError("Your role is not FACULTY. Contact admin.");
        return;
      }

      assignments = await fetchAssignments(user.uid);
      renderSubjectCards();
    } catch (err) {
      showError("Failed to load your role / assigned subjects: " + err.message);
    }
  });
</script>

</body>
</html>
