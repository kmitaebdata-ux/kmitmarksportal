<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KMIT Marks Portal – Admin Dashboard v2 (Fixed Unauthorized Domain)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex bg-gray-100">

<!-- ERROR BOX -->
<div id="errorBox" class="hidden m-4 p-3 bg-red-100 text-red-700 text-sm rounded"></div>

<!-- SIDEBAR -->
<aside id="sidebar" class="hidden w-64 bg-slate-900 text-white flex flex-col">
  <div class="p-4 border-b border-slate-700 text-lg font-bold">KMIT Admin Panel</div>
  <nav class="flex-1 p-3 space-y-2 text-sm" id="nav-links">
    <button data-target="overview" class="w-full text-left px-3 py-2 rounded bg-slate-800">Overview</button>
    <button data-target="marks" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Marks Management</button>
    <button data-target="roles" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">User & Role Management</button>
    <button data-target="bulkroles" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Bulk Role Upload</button>
    <button data-target="reports" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Reports</button>
    <button data-target="logs" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">System Logs</button>
  </nav>
  <div class="p-3 border-t border-slate-700 text-xs">
    <div id="admin-email" class="truncate mb-2">Loading...</div>
    <button id="sign-out-btn" class="w-full bg-red-500 py-2 rounded text-xs">Sign Out</button>
  </div>
</aside>

<!-- MAIN APP -->
<main id="mainApp" class="hidden flex-1 p-6 overflow-y-auto">
  <section id="panel-overview">
    <h2 class="text-2xl font-semibold mb-4">Overview</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white shadow p-4 rounded">Total Students: —</div>
      <div class="bg-white shadow p-4 rounded">Active Faculty: —</div>
      <div class="bg-white shadow p-4 rounded">Pending Approvals: —</div>
    </div>
  </section>

  <!-- MARKS MANAGEMENT (unchanged layout) -->
  <section id="panel-marks" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">Marks Management</h2>
    <div class="bg-white p-4 shadow rounded mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
      <div><label class="block mb-1 font-semibold">Batch</label><input id="marks-batch" class="border p-2 w-full rounded" placeholder="2024-2025" /></div>
      <div><label class="block mb-1 font-semibold">Regulation</label><select id="marks-reg" class="border p-2 w-full rounded"><option>KR24</option><option>R23</option><option>R22</option></select></div>
      <div><label class="block mb-1 font-semibold">Branch</label><select id="marks-branch" class="border p-2 w-full rounded"><option>CSE</option><option>CSD</option><option>CSM</option><option>IT</option><option>ECE</option></select></div>
      <div><label class="block mb-1 font-semibold">Year</label><select id="marks-year" class="border p-2 w-full rounded"><option>I</option><option>II</option><option>III</option><option>IV</option></select></div>
      <div><label class="block mb-1 font-semibold">Semester</label><select id="marks-sem" class="border p-2 w-full rounded"><option>I</option><option>II</option></select></div>
      <div><label class="block mb-1 font-semibold">Exam Type</label><select id="marks-exam" class="border p-2 w-full rounded"><option value="MID1">I MID</option><option value="MID2">II MID</option><option value="SEM">SEMESTER</option></select></div>
    </div>

    <button id="generate-template" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm mb-4">Generate Template (Option A)</button>
    <div id="template-preview" class="hidden bg-white p-4 shadow rounded overflow-x-auto text-xs"></div>
  </section>

  <!-- ROLES -->
  <section id="panel-roles" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">User & Role Management</h2>
    <form id="role-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 shadow rounded">
      <input name="uid" placeholder="User UID" class="border p-2 rounded text-sm" required />
      <select name="role" class="border p-2 rounded text-sm"><option value="ADMIN">ADMIN</option><option value="FACULTY">FACULTY</option><option value="HOD">HOD</option><option value="EXAMCELL">EXAMCELL</option></select>
      <button class="bg-indigo-600 text-white p-2 rounded text-sm">Save Role</button>
    </form>
    <div id="role-status" class="text-xs mt-2 text-slate-600"></div>
  </section>

  <!-- BULK ROLES -->
  <section id="panel-bulkroles" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">Bulk Role Upload</h2>
    <div class="bg-white p-4 rounded shadow mb-4"><h3 class="font-semibold mb-2 text-sm">Step 1 — Select CSV File</h3><input type="file" id="bulk-csv" class="mb-3" /><button id="download-sample" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Download Sample CSV</button></div>
    <div id="preview-panel" class="hidden bg-white p-4 rounded shadow mb-4"><h3 class="font-semibold mb-2 text-sm">Step 2 — Preview Parsed Data</h3><table class="w-full text-xs border" id="preview-table"></table></div>
    <div id="validate-panel" class="hidden bg-white p-4 rounded shadow mb-4"><button id="validate-csv" class="bg-yellow-600 text-white px-4 py-2 rounded text-sm">Validate CSV</button><p id="validation-status" class="text-xs mt-2 text-slate-600"></p></div>
    <div id="process-panel" class="hidden bg-white p-4 rounded shadow mb-4"><button id="bulk-process" class="bg-emerald-700 text-white px-4 py-2 rounded text-sm">Process & Assign Roles</button></div>
    <pre id="bulk-output" class="bg-black text-green-400 p-3 mt-3 text-xs h-64 overflow-auto"></pre>
  </section>

  <section id="panel-reports" class="hidden"><h2 class="text-2xl font-semibold mb-4">Reports</h2></section>
  <section id="panel-logs" class="hidden"><h2 class="text-2xl font-semibold mb-4">System Logs</h2><ul id="logs-list" class="text-xs bg-white p-3 shadow rounded h-64 overflow-auto"></ul></section>
</main>

<!-- FIREBASE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1Aa_mnq_0g7ZEuLbYVjN62iCMWemlKUc",
  authDomain: "kmit-marks-portal-9db76.firebaseapp.com",
  projectId: "kmit-marks-portal-9db76"
};

const app = initializeApp(firebaseConfig);\const auth = getAuth(app);
const provider = new GoogleAuthProvider();

function showError(msg) {
  const box = document.getElementById("errorBox");
