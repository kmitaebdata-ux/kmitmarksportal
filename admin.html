<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KMIT Marks Portal – Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex bg-gray-100">

<!-- ERROR BOX -->
<div id="errorBox" class="hidden m-4 p-3 bg-red-100 text-red-700 text-sm rounded"></div>

<!-- SIDEBAR -->
<aside id="sidebar" class="hidden w-64 bg-slate-900 text-white flex flex-col">
  <div class="p-4 border-b border-slate-700 text-lg font-bold">KMIT Admin Panel</div>
  <nav class="flex-1 p-3 space-y-2 text-sm" id="nav-links">
    <button data-target="overview" class="w-full text-left px-3 py-2 rounded bg-slate-800">Overview</button>
    <button data-target="marks" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Marks Management</button>
    <button data-target="roles" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">User & Role Management</button>
    <button data-target="bulkroles" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Bulk Role Upload</button>
    <button data-target="reports" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Reports</button>
    <button data-target="logs" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">System Logs</button>
  </nav>
  <div class="p-3 border-t border-slate-700 text-xs">
    <div id="admin-email" class="truncate mb-2">Loading...</div>
    <button id="sign-out-btn" class="w-full bg-red-500 py-2 rounded text-xs">Sign Out</button>
  </div>
</aside>

<!-- MAIN APP -->
<main id="mainApp" class="hidden flex-1 p-6 overflow-y-auto">
  <!-- OVERVIEW -->
  <section id="panel-overview">
    <h2 class="text-2xl font-semibold mb-4">Overview</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white shadow p-4 rounded">Total Students: —</div>
      <div class="bg-white shadow p-4 rounded">Active Faculty: —</div>
      <div class="bg-white shadow p-4 rounded">Pending Approvals: —</div>
    </div>
  </section>

  <!-- MARKS MANAGEMENT -->
  <section id="panel-marks" class="hidden mt-6">
    <h2 class="text-2xl font-semibold mb-4">Marks Management</h2>
    <div class="bg-white p-4 shadow rounded mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
      <div>
        <label class="block mb-1 font-semibold">Batch</label>
        <input id="marks-batch" class="border p-2 w-full rounded" placeholder="2024-2025" />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Regulation</label>
        <select id="marks-reg" class="border p-2 w-full rounded">
          <option>KR24</option>
          <option>R23</option>
          <option>R22</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">Branch</label>
        <select id="marks-branch" class="border p-2 w-full rounded">
          <option>CSE</option>
          <option>CSD</option>
          <option>CSM</option>
          <option>IT</option>
          <option>ECE</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">Year</label>
        <select id="marks-year" class="border p-2 w-full rounded">
          <option>I</option>
          <option>II</option>
          <option>III</option>
          <option>IV</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">Semester</label>
        <select id="marks-sem" class="border p-2 w-full rounded">
          <option>I</option>
          <option>II</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">Exam Type</label>
        <select id="marks-exam" class="border p-2 w-full rounded">
          <option value="MID1">I MID</option>
          <option value="MID2">II MID</option>
          <option value="SEM">SEMESTER</option>
        </select>
      </div>
    </div>

    <button id="generate-template" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm mb-4">
      Generate Template (Option A)
    </button>
    <div id="template-preview" class="hidden bg-white p-4 shadow rounded overflow-x-auto text-xs"></div>
  </section>

  <!-- ROLES -->
  <section id="panel-roles" class="hidden mt-6">
    <h2 class="text-2xl font-semibold mb-4">User & Role Management</h2>
    <form id="role-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 shadow rounded">
      <input name="uid" placeholder="User UID" class="border p-2 rounded text-sm" required />
      <select name="role" class="border p-2 rounded text-sm">
        <option value="ADMIN">ADMIN</option>
        <option value="FACULTY">FACULTY</option>
        <option value="HOD">HOD</option>
        <option value="EXAMCELL">EXAMCELL</option>
      </select>
      <button class="bg-indigo-600 text-white p-2 rounded text-sm">Save Role</button>
    </form>
    <div id="role-status" class="text-xs mt-2 text-slate-600"></div>
  </section>

  <!-- BULK ROLES -->
  <section id="panel-bulkroles" class="hidden mt-6">
    <h2 class="text-2xl font-semibold mb-4">Bulk Role Upload</h2>
    <div class="bg-white p-4 rounded shadow mb-4">
      <h3 class="font-semibold mb-2 text-sm">Step 1 — Select CSV File</h3>
      <input type="file" id="bulk-csv" class="mb-3" />
      <button id="download-sample" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">
        Download Sample CSV
      </button>
    </div>
    <div id="preview-panel" class="hidden bg-white p-4 rounded shadow mb-4">
      <h3 class="font-semibold mb-2 text-sm">Step 2 — Preview Parsed Data</h3>
      <table class="w-full text-xs border" id="preview-table"></table>
    </div>
    <div id="validate-panel" class="hidden bg-white p-4 rounded shadow mb-4">
      <button id="validate-csv" class="bg-yellow-600 text-white px-4 py-2 rounded text-sm">Validate CSV</button>
      <p id="validation-status" class="text-xs mt-2 text-slate-600"></p>
    </div>
    <div id="process-panel" class="hidden bg-white p-4 rounded shadow mb-4">
      <button id="bulk-process" class="bg-emerald-700 text-white px-4 py-2 rounded text-sm">
        Process & Assign Roles
      </button>
    </div>
    <pre id="bulk-output" class="bg-black text-green-400 p-3 mt-3 text-xs h-64 overflow-auto"></pre>
  </section>

  <!-- REPORTS -->
  <section id="panel-reports" class="hidden mt-6">
    <h2 class="text-2xl font-semibold mb-4">Reports</h2>
    <p class="text-sm text-slate-600">Reports module placeholder.</p>
  </section>

  <!-- LOGS -->
  <section id="panel-logs" class="hidden mt-6">
    <h2 class="text-2xl font-semibold mb-4">System Logs</h2>
    <ul id="logs-list" class="text-xs bg-white p-3 shadow rounded h-64 overflow-auto"></ul>
  </section>
</main>

<!-- INLINE FIREBASE + ADMIN LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC1Aa_mnq_0g7ZEuLbYVjN62iCMWemlKUc",
    authDomain: "kmit-marks-portal-9db76.firebaseapp.com",
    projectId: "kmit-marks-portal-9db76",
    storageBucket: "kmit-marks-portal-9db76.firebasestorage.app",
    messagingSenderId: "264909025742",
    appId: "1:264909025742:web:84de5216860219e6bc3b9f",
    measurementId: "G-JMZ564P8PJ"
  };

  const appId = "kmit-marks-portal";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const errorBox = document.getElementById("errorBox");
  const sidebar = document.getElementById("sidebar");
  const mainApp = document.getElementById("mainApp");
  const adminEmailEl = document.getElementById("admin-email");

  function showError(msg) {
    if (!errorBox) return;
    errorBox.textContent = msg;
    errorBox.classList.remove("hidden");
  }

  function hideError() {
    if (!errorBox) return;
    errorBox.classList.add("hidden");
    errorBox.textContent = "";
  }

  async function verifyAdminRole(user) {
    try {
      const roleDocRef = doc(
        db,
        "artifacts",
        appId,
        "users",
        user.uid,
        "user_config",
        "role"
      );
      const snap = await getDoc(roleDocRef);
      if (!snap.exists()) {
        throw new Error("Role document not found for this user.");
      }
      const role = String(snap.data().role || "").toUpperCase();
      if (role !== "ADMIN") {
        throw new Error(
          `Access denied. Your role is "${role}". Only ADMIN can open this dashboard.`
        );
      }
      return true;
    } catch (err) {
      console.error("verifyAdminRole error", err);
      showError(
        "Admin access check failed: " +
          (err?.message || JSON.stringify(err))
      );
      return false;
    }
  }

  function setupNav() {
    const buttons = document.querySelectorAll("#nav-links button");
    const panels = document.querySelectorAll("main section");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");
        // toggle button styling
        buttons.forEach((b) =>
          b.classList.remove("bg-slate-800")
        );
        btn.classList.add("bg-slate-800");

        // toggle panels
        panels.forEach((p) => {
          if (p.id === "panel-" + target) {
            p.classList.remove("hidden");
          } else {
            p.classList.add("hidden");
          }
        });
      });
    });
  }

  function setupMarksTemplateButton() {
    const btn = document.getElementById("generate-template");
    const preview = document.getElementById("template-preview");
    if (!btn || !preview) return;

    btn.addEventListener("click", () => {
      const batch = document.getElementById("marks-batch").value || "2024-2025";
      const reg = document.getElementById("marks-reg").value || "KR24";
      const branch = document.getElementById("marks-branch").value || "CSE";
      const year = document.getElementById("marks-year").value || "I";
      const sem = document.getElementById("marks-sem").value || "I";
      const exam = document.getElementById("marks-exam").value || "MID1";

      // Simple sample template; you can enhance this later.
      const header = [
        "SNO",
        "HALLTICKET",
        "NAME",
        "BATCH",
        "REGULATION",
        "BRANCH",
        "YEAR",
        "SEM",
        "EXAM",
        "MARKS"
      ];

      const rows = [];
      for (let i = 1; i <= 5; i++) {
        rows.push([
          i,
          "HTNO" + i.toString().padStart(3, "0"),
          "STUDENT " + i,
          batch,
          reg,
          branch,
          year,
          sem,
          exam,
          ""
        ]);
      }

      let html = '<table class="min-w-full border text-xs">';
      html += "<thead><tr>";
      header.forEach((h) => {
        html += `<th class="border px-2 py-1 bg-slate-100">${h}</th>`;
      });
      html += "</tr></thead><tbody>";
      rows.forEach((r) => {
        html += "<tr>";
        r.forEach((v) => {
          html += `<td class="border px-2 py-1">${v}</td>`;
        });
        html += "</tr>";
      });
      html += "</tbody></table>";

      preview.innerHTML = html;
      preview.classList.remove("hidden");
    });
  }

  function setupSignOut() {
    const btn = document.getElementById("sign-out-btn");
    if (!btn) return;
    btn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (err) {
        console.error("Sign-out error", err);
        showError("Sign-out failed: " + (err?.message || err));
      }
    });
  }

  onAuthStateChanged(
    auth,
    async (user) => {
      hideError();
      if (!user) {
        // Not logged in -> send back to landing page
        window.location.href = "index.html";
        return;
      }

      adminEmailEl.textContent = user.email || "Unknown admin";

      const ok = await verifyAdminRole(user);
      if (!ok) return;

      // Show UI
      sidebar.classList.remove("hidden");
      mainApp.classList.remove("hidden");

      // setup UI handlers
      setupNav();
      setupMarksTemplateButton();
      setupSignOut();
    },
    (err) => {
      console.error("onAuthStateChanged error", err);
      showError(
        "Failed to listen to auth state changes: " +
          (err?.message || err)
      );
    }
  );
</script>

</body>
</html>
